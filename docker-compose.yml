version: '2'
services:
  youtrack:
    container_name: youtrack
    image: pojo-youtrack:latest
    build:
      context: .
      dockerfile: Dockerfile-youtrack
      args:
        - YOUTRACK_VERSION=2017.1.30791
    ports:
      - 8080:8080
    volumes:
      - ./youtrack/backups:/youtrack/backups:rw
      - ./youtrack/data:/youtrack/data:rw
      - ./youtrack/logs:/youtrack/logs:rw
      - ./youtrack/conf:/youtrack/conf:rw
      - ./youtrack/temp:/youtrack/temp:rw
    restart: always
    links:
      - teamcity

  teamcity:
    container_name: teamcity
    image: pojo-teamcity:latest
    build:
      context: .
      dockerfile: Dockerfile-teamcity
    ports:
      - 8081:8111
    volumes:
      - ./teamcity/data:/data/teamcity_server/datadir:rw
      - ./teamcity/logs:/opt/teamcity/logs:rw
    restart: always
    depends_on:
      - postgres
    links:
      - postgres

  postgres:
    container_name: postgres
    image: postgres:latest
    ports:
      - 5432:5432
    restart: always

  teamcity-agent:
    container_name: teamcity-agent
    image: jetbrains/teamcity-agent:latest
    environment:
      - "AGENT_NAME=teamcity-agent"
      - "SERVER_URL=teamcity:8111"
    volumes:
      - "./teamcity/agents/teamcity-agent:/data/teamcity_agent/conf:rw"
    restart: always
    links:
      - teamcity

  upsource:
    container_name: upsource
    image: pojo-upsource:latest
    build:
      context: .
      dockerfile: Dockerfile-upsource
      args:
        - UPSOURCE_VERSION=3.0.4423
    ports:
      - 8082:8080
    volumes:
      - ./upsource/backups:/upsource/backups:rw
      - ./upsource/data:/upsource/data:rw
      - ./upsource/logs:/upsource/logs:rw
      - ./upsource/conf:/upsource/conf:rw
      - ./upsource/temp:/upsource/temp:rw
    restart: always
    links:
      - youtrack
      - teamcity